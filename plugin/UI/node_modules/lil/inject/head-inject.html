

<!-- liltype -->

<script src="http://localhost:%PORT%/socket.io/socket.io.js"></script>
<script type="text/javascript">

%JQUERY%


var lil = {

  origin: location.protocol + '//' + location.host + '/',
  scripts: {},
  stylesheets: {},
  introducedGlobals: {},
  inversions: {},
  window: {},
  $: $,

  log: function() {
    args = lil.$.makeArray(arguments);
    args[0] = '[lil] ' + args[0];
    console.log.apply(console, args);
  },

  error: function() {
    args = lil.$.makeArray(arguments);
    args[0] = '[lil] ' + args[0];
    console.error.apply(console, args);
  },

  socket: (function() {

    var socket = io.connect('http://localhost:%PORT%');

    socket.on('css', function (data) {
      if (data.type === 'change') {
        lil.reloadCss(data.target);
      }
    });

    socket.on('js', function (data) {
      if (data.type === 'change') {
        lil.teardownScript(data.target);
        lil.reloadScript(data.target);
      }
    });

    socket.on('reload', function() {
      location.reload();
    })

    return socket;

  })(),

  begin: function(file) {

    var found = false;
    // find matching script tag
    lil.$('script').each(function(k, script) {
      if ('./'+script.src.replace(lil.origin, '') === file) {
        if (lil.scripts[file]) {
          // lil.log('Still watching script ' + file);
        } else { 
          lil.log('Watching script ' + file);
        }
        lil.scripts[file] = script;
        found = true;
      }
    });
    if (!found) lil.error('Could not find matching script for ' + file);

    for (var k in window) {
      lil.window[k] = true;
      lil.currentFile = file;
    }

  },

  end: function() {

    var globals = [];
    lil.introducedGlobals[lil.currentFile] = globals;
    for (var k in window) {

      if (!(k in lil.window)) {
        console.log(k);
        globals.push[k];
      }
    }

    for (var k in lil.window) {
      delete lil.window[k];
    }

  },

  teardownScript: function(target) {
    // destroy globals
    if (!lil.introducedGlobals[target]) {
      lil.error('Never heard of the javascript file ' + target);
      return;
    }
    lil.$.each(lil.introducedGlobals[target], function(k, v) {
      delete window[k];
    });

    if (!lil.inversions[target]) return;
    lil.$.each(lil.inversions[target], function(k, v) {
      var scope = v[0];
      var method = v[1];
      var args = v[2];

      try { 
        scope[method].apply(scope, args);
        lil.log('Inversion via ' + method);
      } catch (e) {
        lil.log('Inverter error on ' + method);
        lil.log(e);
      }
    });
    lil.inversions[target].length = 0;

  },

  reloadScript: function(target) {

    lil.log('Reloading ' + target);

    var script = lil.scripts[target];
    var parent = lil.parent(script);

    var newScript = document.createElement('script');

    newScript.type = script.type;
    newScript.src = script.src;
    parent.removeChild(script);
    parent.appendChild(newScript);

    lil.scripts[target] = newScript;

  },

  reloadCss: function(target) {

    lil.log('Reloading ' + target);
    
    var sheet = lil.stylesheets[target];
    var parent = lil.parent(sheet);

    var newSheet = document.createElement('link');
    newSheet.rel = sheet.rel;
    newSheet.href = sheet.href;
    newSheet.type = sheet.type;
    newSheet.media = sheet.media;

    parent.appendChild(newSheet);
    setTimeout(function() {
      parent.removeChild(sheet);
    }, 90);

    lil.stylesheets[target] = newSheet;
    
  },

  parent: function(elem) {
    return elem.parentNode;
  }
  
};

function invert(obj, method, inverse) {

  obj['_'+method] = function(file) {
    var _this = this;
    return function() {
      var args = lil.$.makeArray(arguments);
      lil.inversions[file] = lil.inversions[file] || [];
      lil.inversions[file].push([_this, inverse, args]);
      obj[method].apply(_this, args);
    };
  }


}

invert(Node.prototype, 'appendChild', 'removeChild');
invert(Node.prototype, 'addEventListener', 'removeEventListener');
invert(window, 'addEventListener', 'removeEventListener');

</script>

<!-- liltype -->

